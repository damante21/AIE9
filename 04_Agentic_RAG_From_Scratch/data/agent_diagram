                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  rag_agent_with_memory.invoke(                              â”‚
â”‚    {"messages": [HumanMessage(...)]},                       â”‚
â”‚    config={"configurable": {"thread_id": "conv_1"}}         â”‚
â”‚  )                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   MemorySaver        â”‚
              â”‚   Checkpoint System  â”‚
              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚       â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                                  â–¼
   [Found State]                    [No State Found]
   Load previous                    Start fresh with
   conversation                     initial messages
         â”‚                                  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚      START            â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚   agent node            â”‚
           â”‚   (rag_agent_node)      â”‚
           â”‚   â€¢ Calls LLM           â”‚
           â”‚   â€¢ Has tools bound     â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
              [ğŸ’¾ STATE SAVED]
                      â”‚
                      â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚  custom_should_continue()  â”‚
           â”‚                            â”‚
           â”‚  1ï¸âƒ£ Count ToolMessages:    â”‚
           â”‚     tool_call_count = sum( â”‚
           â”‚       1 for msg if         â”‚
           â”‚       isinstance(msg,      â”‚
           â”‚       ToolMessage)         â”‚
           â”‚     )                      â”‚
           â”‚                            â”‚
           â”‚  2ï¸âƒ£ Check limit:           â”‚
           â”‚     if count >= 10:        â”‚
           â”‚       return "max_reached" â”‚
           â”‚                            â”‚
           â”‚  3ï¸âƒ£ Check tool calls:      â”‚
           â”‚     if last_message.       â”‚
           â”‚       tool_calls:          â”‚
           â”‚       return "tools"       â”‚
           â”‚                            â”‚
           â”‚  4ï¸âƒ£ Otherwise:             â”‚
           â”‚     return "end"           â”‚
           â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
               â”‚        â”‚           â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â–¼                 â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  tools   â”‚      â”‚   END   â”‚      â”‚ max_iterations â”‚
â”‚  node    â”‚      â”‚         â”‚      â”‚     node       â”‚
â”‚          â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚                â”‚
â”‚Available â”‚                       â”‚Returns message:â”‚
â”‚Tools:    â”‚                       â”‚"Reached max    â”‚
â”‚â€¢ search_ â”‚                       â”‚ tool calls..."  â”‚
â”‚  wellnessâ”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚â€¢ calculate                              â”‚
â”‚â€¢ get_timeâ”‚                        [ğŸ’¾ STATE SAVED]
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                              â”‚
     â”‚                                    â–¼
[ğŸ’¾ STATE SAVED]                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                              â”‚   END   â”‚
     â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â””â”€â”€â–º loops back to
          agent node


â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
STATE STRUCTURE:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
class AgentState(TypedDict):
    messages: Annotated[list[BaseMessage], add_messages]
    # add_messages reducer appends new messages

Message Types in State:
â€¢ HumanMessage - User input
â€¢ AIMessage - LLM response (may include tool_calls)
â€¢ ToolMessage - Tool execution results


â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
MEMORY/CHECKPOINTING:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â€¢ MemorySaver saves state after EVERY node execution
â€¢ thread_id in config identifies conversation
â€¢ Same thread_id = loads previous conversation
â€¢ Different thread_id = starts new conversation


â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
EXAMPLE CONVERSATION FLOW WITH MEMORY:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Turn 1: "tips for sleep?"
  â†’ MemorySaver: No state found, start fresh
  â†’ Graph executes â†’ State saved with thread_id
  â†’ State contains: [HumanMsg, AIMsg, ToolMsg, AIMsg]

Turn 2: "what about exercise?"  (same thread_id)
  â†’ MemorySaver: Found state! Load it
  â†’ New message added to existing messages
  â†’ State contains: [Turn 1 messages] + [new HumanMsg, ...]
  â†’ Agent sees full context, can reference "sleep"

Turn 3: "summarize everything"  (same thread_id)
  â†’ MemorySaver: Load entire conversation
  â†’ Agent summarizes all previous turns